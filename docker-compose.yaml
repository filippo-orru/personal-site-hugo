version: '3'

services:
  nginx:
    image: nginx:alpine
    volumes:
      - ./public:/usr/share/nginx/html
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.filippo-orru.rule=Host(`filippo-orru.com`)"
      - "traefik.http.routers.filippo-orru.entrypoints=https"
      - "traefik.http.routers.filippo-orru.tls=true"
      - "traefik.http.services.filippo-orru.loadbalancer.server.port=80"

  webhook-listener:
    build: webhook-listener
    expose:
      - 8080
    environment:
      - PORT: 8080
      - COMMAND: "cd /src && git config --global --add safe.directory /src && git pull && hugo -b filippo-orru.com --ignoreCache --minify -s /src -d /target"
    volumes:
      - ./:/src
      - ./public:/target
    secrets:
      - webhook_secret
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.filippo-orru-webhook.rule=Host(`filippo-orru.com`) && PathPrefix(`/webhook`)"
      - "traefik.http.routers.filippo-orru-webhook.entrypoints=https"
      - "traefik.http.routers.filippo-orru-webhook.tls=true"
      - "traefik.http.services.filippo-orru-webhook.loadbalancer.server.port=8080"

secrets:
  webhook_secret:
    file: ./webhook.secret

networks:
  default:
    external: true
    name: traefik_proxy
